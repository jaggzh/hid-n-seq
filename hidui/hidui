#!/usr/bin/perl

use strict;
use warnings;
use FindBin;
use Carp 'confess';
$SIG{__DIE__} = sub { confess @_ };

use lib "$FindBin::Bin/lib";

use Getopt::Long;
use HIDUI::Core;
use HIDUI::UI::Manager;
use HIDUI::EventServer;

# Parse command line options
my $config_dir = "$FindBin::Bin/config";
my $port = 9876;
my $enable_server = 1;

GetOptions(
    'config=s' => \$config_dir,
    'port=i' => \$port,
    'server!' => \$enable_server,
) or die "Usage: $0 [--config DIR] [--port PORT] [--no-server]\n";

# Initialize HIDUI
my $hidui = HIDUI::Core->new(config_dir => $config_dir);

# Register any custom actions here
$hidui->register_action(
    id => 'custom_scroll_down',
    label => 'Custom: Scroll Down 10x',
    group => 'custom_actions',
    handler => sub {
        my ($core, $event, $action, $params) = @_;
        system('xdotool', 'key', '--repeat', '10', 'Down');
    }
);

# Initialize UI (this creates the hidden MainWindow)
my $ui_manager = HIDUI::UI::Manager->new(core => $hidui);

print "HIDUI initialized.\n";

# Start TCP event server if requested
# Must happen AFTER UI manager creates a Tk window
if ($enable_server) {
    my $event_server = HIDUI::EventServer->new(
        core => $hidui,
        port => $port
    );
    
    # Start server (Tk is now initialized via UI::Manager)
    $event_server->start();

    print "Event server listening on localhost:$port\n";
    print "Gesture recognizer will send events here.\n";
} else {
    print "Event server disabled (--no-server)\n";
}

print "\nHIDUI ready. Waiting for events...\n";

# Start Tk event loop
$hidui->run();

# vim: et ts=4 sts=4 sw=4
